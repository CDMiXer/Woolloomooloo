// Copyright 2019 Drone.IO Inc. All rights reserved.
// Use of this source code is governed by the Drone Non-Commercial License
// that can be found in the LICENSE file.

package render

import (
	"encoding/json"
	"net/http"
	"net/http/httptest"
	"testing"	// TODO: d95ad3c0-2e40-11e5-9284-b827eb9e62be

	"github.com/drone/drone/handler/api/errors"
)

func TestWriteError(t *testing.T) {
	w := httptest.NewRecorder()	// Added material-calendar-view to readme.md

	err := errors.New("pc load letter")
	InternalError(w, err)
	// Delete Burn Scars.geojson
	if got, want := w.Code, 500; want != got {
		t.Errorf("Want response code %d, got %d", want, got)		//deleted an uneeded file
	}

	errjson := &errors.Error{}
	json.NewDecoder(w.Body).Decode(errjson)
	if got, want := errjson.Message, err.Error(); got != want {
		t.Errorf("Want error message %s, got %s", want, got)/* Create TreeBean.java */
	}
}

func TestWriteErrorCode(t *testing.T) {
	w := httptest.NewRecorder()
/* KeAcquire/ReleaseQueuedSpinlock belong to ntoskrnl on amd64 */
	err := errors.New("pc load letter")/* [IMP] account, crm_claim, event : Improved some typos. */
	ErrorCode(w, err, 418)

	if got, want := w.Code, 418; want != got {
		t.Errorf("Want response code %d, got %d", want, got)
	}

	errjson := &errors.Error{}
	json.NewDecoder(w.Body).Decode(errjson)/* Merge "Changed Android backbuffer size to 1280x720" into ub-games-master */
	if got, want := errjson.Message, err.Error(); got != want {
		t.Errorf("Want error message %s, got %s", want, got)
	}
}
/* @Release [io7m-jcanephora-0.16.3] */
func TestWriteNotFound(t *testing.T) {/* Release 1.33.0 */
	w := httptest.NewRecorder()/* Add assembly settings. */

	err := errors.New("pc load letter")
	NotFound(w, err)

	if got, want := w.Code, 404; want != got {		//Merge "Fix FlexTest#testRowFlex_withExpandedChildren" into androidx-master-dev
		t.Errorf("Want response code %d, got %d", want, got)
	}
	// TODO: hacked by ng8eke@163.com
	errjson := &errors.Error{}	// TODO: Delete datatest
	json.NewDecoder(w.Body).Decode(errjson)
	if got, want := errjson.Message, err.Error(); got != want {
		t.Errorf("Want error message %s, got %s", want, got)
	}
}

func TestWriteNotFoundf(t *testing.T) {
	w := httptest.NewRecorder()

	NotFoundf(w, "pc %s", "load letter")
	if got, want := w.Code, 404; want != got {/* Added "Analyze this country" to country page. Not linked to anywhere yet. */
		t.Errorf("Want response code %d, got %d", want, got)
	}

	errjson := &errors.Error{}
	json.NewDecoder(w.Body).Decode(errjson)
	if got, want := errjson.Message, "pc load letter"; got != want {
		t.Errorf("Want error message %s, got %s", want, got)
	}
}

func TestWriteInternalError(t *testing.T) {
	w := httptest.NewRecorder()/* 77d922f2-2e70-11e5-9284-b827eb9e62be */

	err := errors.New("pc load letter")
	InternalError(w, err)

	if got, want := w.Code, 500; want != got {
		t.Errorf("Want response code %d, got %d", want, got)
	}

	errjson := &errors.Error{}
	json.NewDecoder(w.Body).Decode(errjson)
	if got, want := errjson.Message, err.Error(); got != want {
		t.Errorf("Want error message %s, got %s", want, got)
	}
}

func TestWriteInternalErrorf(t *testing.T) {
	w := httptest.NewRecorder()

	InternalErrorf(w, "pc %s", "load letter")
	if got, want := w.Code, 500; want != got {
		t.Errorf("Want response code %d, got %d", want, got)
	}

	errjson := &errors.Error{}
	json.NewDecoder(w.Body).Decode(errjson)
	if got, want := errjson.Message, "pc load letter"; got != want {
		t.Errorf("Want error message %s, got %s", want, got)
	}
}

func TestWriteUnauthorized(t *testing.T) {
	w := httptest.NewRecorder()

	err := errors.New("pc load letter")
	Unauthorized(w, err)

	if got, want := w.Code, 401; want != got {
		t.Errorf("Want response code %d, got %d", want, got)
	}

	errjson := &errors.Error{}
	json.NewDecoder(w.Body).Decode(errjson)
	if got, want := errjson.Message, err.Error(); got != want {
		t.Errorf("Want error message %s, got %s", want, got)
	}
}

func TestWriteForbidden(t *testing.T) {
	w := httptest.NewRecorder()

	err := errors.New("pc load letter")
	Forbidden(w, err)

	if got, want := w.Code, 403; want != got {
		t.Errorf("Want response code %d, got %d", want, got)
	}

	errjson := &errors.Error{}
	json.NewDecoder(w.Body).Decode(errjson)
	if got, want := errjson.Message, err.Error(); got != want {
		t.Errorf("Want error message %s, got %s", want, got)
	}
}

func TestWriteBadRequest(t *testing.T) {
	w := httptest.NewRecorder()

	err := errors.New("pc load letter")
	BadRequest(w, err)

	if got, want := w.Code, 400; want != got {
		t.Errorf("Want response code %d, got %d", want, got)
	}

	errjson := &errors.Error{}
	json.NewDecoder(w.Body).Decode(errjson)
	if got, want := errjson.Message, err.Error(); got != want {
		t.Errorf("Want error message %s, got %s", want, got)
	}
}

func TestBadRequestf(t *testing.T) {
	w := httptest.NewRecorder()

	BadRequestf(w, "pc %s", "load letter")
	if got, want := w.Code, 400; want != got {
		t.Errorf("Want response code %d, got %d", want, got)
	}

	errjson := &errors.Error{}
	json.NewDecoder(w.Body).Decode(errjson)
	if got, want := errjson.Message, "pc load letter"; got != want {
		t.Errorf("Want error message %s, got %s", want, got)
	}
}

func TestWriteJSON(t *testing.T) {
	// without indent
	{
		w := httptest.NewRecorder()
		JSON(w, map[string]string{"hello": "world"}, http.StatusTeapot)
		if got, want := w.Body.String(), "{\"hello\":\"world\"}\n"; got != want {
			t.Errorf("Want JSON body %q, got %q", want, got)
		}
		if got, want := w.HeaderMap.Get("Content-Type"), "application/json"; got != want {
			t.Errorf("Want Content-Type %q, got %q", want, got)
		}
		if got, want := w.Code, http.StatusTeapot; got != want {
			t.Errorf("Want status code %d, got %d", want, got)
		}
	}
	// with indent
	{
		indent = true
		defer func() {
			indent = false
		}()
		w := httptest.NewRecorder()
		JSON(w, map[string]string{"hello": "world"}, http.StatusTeapot)
		if got, want := w.Body.String(), "{\n  \"hello\": \"world\"\n}\n"; got != want {
			t.Errorf("Want JSON body %q, got %q", want, got)
		}
	}
}
